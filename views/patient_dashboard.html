<!DOCTYPE html>
<html lang="en">
<head>
  <title>Baobab Health Trust</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/css/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/css/maindashboard/header.css">
  <link rel="stylesheet" href="/assets/css/maindashboard/footer.css">
  <link rel="stylesheet" href="/assets/css/custom.css">
  <link rel="stylesheet" href="/assets/css/patientdashboard.css">
  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/bootstrap/bootstrap.min.js"></script>
  <script src="/assets/js/moment.js"></script>
</head>
<body>
  <script src="/assets/js/generic_ajaxrequest.js">
      // checkIfEnconterCaptured("vitals");   
  </script>    

  <style>
  .modal-body {
   
    overflow-y: auto;
}
  </style>
  
  <!-- container -->
  <div class="container" style="width: 100%; margin-bottom: 1%;">

    <!-- left card -->
    <div class="col-sm-8 col-lg-8 col-md-8 col-xs-8 cards" style="margin-top: 0.7%; border: solid 1px; border-radius: 1%; height: 115px; padding: 0; width: 65%; margin-left: 1%;">
    
      <div class="col-md-12" style="display: flex;">
        <span style="width: 50%; display: flex;">
          <img style="height: 28px; width:28px; margin-top: 2px" id="icon_id" alt="person_icon">
          <h4 id="patient_name"></h4> <h4 style="margin-left: 40px;" id=""></h4>
        </span>
        <h4>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <strong>National ID:</strong>
        </h4>
        <h4 id="npid" style="margin-left: 10px;"></h4>   
      </div>
          
      <div class="col-md-12 h4" style="display: flex;">
        <span style="width: 50%; display: flex;">
          <strong>Date&nbsp;of&nbsp;Birth:</strong> &nbsp;&nbsp;&nbsp;<span id="DOB" style="margin-left: 20px; ">
          </span>
          <span style="margin-left: 20px;" id="age"></span> 
        </span>
        <span style="margin-left: 40px;">
          <strong>Phone Number:</strong>
        </span> 
        <span id="phone_number" style="margin-left: 40px;"></span>
      </div>
        
      <div class="col-md-12 h4" style="display: flex;"> 
          <strong>Current Address</strong> 
          <span id="addressl1" style="margin-left: 40px;"></span> 
          <span id="addressl3" style="margin-left: 40px;"></span>
      </div>
  
    </div>
    <!-- /left card -->
  
    <!-- right card-->
    <div class="col-sm-4 col-lg-4 col-md-4 col-xs-4 cards" style="margin-top: 0.7%; border: solid 1px;border-radius: 1%; height: 115px; padding: 0;margin-left: 2%; width: 30%;">
        <img src="/assets/images/BaobabHealth.png" id="application-icon" style="height: 80%; border:solid 1px;border-radius: 50%; margin-top: 2%;;margin-left: 1%; width: 30%; float: left; box-shadow: 0 10px 14px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);">
        <h3 style="text-align: center" id="application-name">ART</h3>
        <h5 style="text-align: center"> v1.0.0</h5>
    </div>
    <!-- /right card-->


    <!-- visits div -->
    <div class="col-sm-2 col-lg-2 col-xl-2 cards"  style="margin-top: 2%; margin-left: 2%; border: solid 1px;overflow: auto; padding: 0; height: 520px; overflow: hidden;">
        <div style="display: flex; margin-left: 35px;"> <h4 id="numberOfVisits">  </h4></h4><h4 class="headers">Visit(s) </h4></div>
        <button class="btn" style="width: 90%; margin-left: 5%; height: 50px; background-color: #b5b1b1;" id="up" > <img src="/assets/images/drop-up-arrow.svg" /></button>
        <div id="dates" style="height: 70%; margin-top: 5%;"> </div>
        <button class="btn" style="width: 90%; margin-left: 5%; height: 50px; bottom: 0; background-color: #b5b1b1;" id="down" > <img src="/assets/images/drop-down-arrow.svg" /></button>
     </div>
    <!-- /visits div-->

    <!-- visit details div-->
    <div class="col-sm-10 col-lg-10 col-md-10 col-xs-10 cards" style="border: solid 2px;width: 80%; padding: 0; margin-left: 1%; height: 520px; margin-top: 2%;margin-right: 2%; width: 78%;" id="generic_tabs">
        <div class="row" style="display: flex;"> <h4 class="headers" style="margin-left: 40px; "> Date Selected: <span id="selectedDate"></span></h4><h4 class="headers"> Next Encounter: <span id="nextEncounter"></span></h4></div>
        <div class="row">
           <div class="col-sm-6 col-lg-6 col-md-6 col-xs-6" style="margin-left: 2%;border: solid 0px; width: 47%; margin-left: 3%;">
              <div class="card text-white bg-primary mb-3 cards" style="width: 98%; height: 200px; overflow: hidden;" data-toggle="modal" data-target="#myModal" onclick="populateModal();">
                 <div class="card-header h4 list-group-item-info" style="margin: 3%; padding: 1%;" id="encounterHeader"></div>
                 <table class="table" style="border: 0;">
                    <tbody id="encounters">
                    </tbody>
                 </table>
                 <div class="card-footer" style="margin: 1%;">
                 </div>
              </div>
           </div>
           
           <div class="col-sm-6 col-lg-6 col-md-6 col-xs-6" style="border: solid 0px; width: 48%; margin-left: 0%;" >
              <div class="card text-white bg-primary mb-3 btn-success cards" style="width: 98%; height: 200px; overflow: hidden;" data-toggle="modal" data-target="#myModal">
                 <div class="card-header h4 list-group-item-info" style="margin: 3%; padding: 1%;">Programs</div>

                 <table class="table ">
                    <tbody id="programs">
                    </tbody>
                 </table>
                 <div class="card-footer" style="margin: 1%;">
                 </div>
              </div>
           </div>  
        </div>
        <div class="row" style="margin-top:10px;">
           <div class="col-sm-6 col-lg-6 col-md-6 col-xs-6" style="border: solid 0px; width: 47%; margin-left: 3%;">
              <div class="card text-white bg-primary mb-3 btn-danger cards" style="width: 98%; height: 200px; overflow: hidden;" data-toggle="modal" data-target="#myModal">
                 <div class="card-header h4 list-group-item-info" style="margin: 3%; padding: 1%;">Alerts</div>
                 <table class="table ">
                    <tbody id="alerts">
                    </tbody>
                 </table>
                 <div class="card-footer" style="margin: 1%;">
                 </div>
              </div>
           </div>
           <div class="col-sm-6 col-lg-6 col-md-6 col-xs-6" style="border: solid 0px; width: 48%; margin-left: 0%; ">
              <div class="card text-white bg-primary mb-3 btn-warning cards" style="width: 98%; height: 200px; overflow: hidden;" data-toggle="modal" data-target="#myModal">
                 <div class="card-header h4 list-group-item-info" style="margin: 3%; padding: 1%;">Latest Medication</div>
                 <table class="table ">
                    <tbody id="medication">
                    </tbody>
                 </table>
                 <div class="card-footer" style="margin: 1%;">
                 </div>
              </div>
           </div>
        </div>
     </div>
    <!-- /visit details div-->
    
    <!-- footer -->
    <footer class="footer">
      <div class="container-footer">
        <button id="btnNext" class="green right" style="margin: 5px 0px 0px; padding: 0px; float: right;" onclick="finish();">
        <span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Finish &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;</span>
        </button>
        <button class="btn btn-success buttons blue" style="margin-right: 5px;" data-toggle="modal" data-target="#appModal">
        <span>&nbsp;&nbsp; Applications &nbsp;&nbsp;<img src="/assets/images/launcher.png"></span>
        </button>
        <button id="activities" class="btn btn-success buttons blue" style="margin-right: 5px;" data-toggle="modal" data-target="#activitiesModal" onmousedown="showActivities(this);" >
        <span>&nbsp; &nbsp; &nbsp; Printouts/Other &nbsp; &nbsp; &nbsp;</span>
        </button>
        <button class="btn btn-success buttons blue" style="margin-right: 5px;" data-toggle="modal" data-target="#appModal">
        <span>&nbsp; &nbsp; &nbsp; Tasks &nbsp; &nbsp; &nbsp;</span>
        </button>
      </div>
    </footer>   
    <!-- /footer -->
  
    <!-- encounters details modal -->
    <div id="myModal" class="modal fade" role="dialog" style="height: 100%;">
        <div class="modal-dialog" >     
          <div class="modal-content" style="margin: 0; max-height: 100%;">
              
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h4 class="modal-title"> Encounter Date: <span id="encounterDate"> </span></h4>
            </div>  
  
            <div class="modal-body" style="height: calc(100vh - 200px); max-height: calc(100vh - 200px); overflow: auto;">
              <div class="col-lg-3 col-sm-3 col-md-3 col-xs-3 border" id="encounters2" style="border-right: solid 1px;"></div>
              
              <div class="col-lg-9 col-sm-9 col-md-9 col-xs-9">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Observation</th>
                      <th>Value</th>
                      <th>Time</th>
                    </tr>
                  </thead>
                  <tbody id="observationsTable">
                  </tbody>
                </table>
              </div>
              
            </div>
                
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
            
          </div>
        </div>
      </div>
    <!-- /encounters details modal -->

    <!-- applications modal-->
    <div class="modal fade" id="appModal" data-backdrop="static" data-keyboard="false" role="dialog">
        <div class="modal-dialog" name="div2">
            <div class="modal-content" style="margin-left:0px;">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Select module</h4>
                 </div>
                 <div class="modal-body">
                    <div class="container">
                       <div class="row" id="modal-div">
                          <template id="card_template">
                             <!-- <div class="" > -->
                             <a href="#" class="card-block clearfix" id="moduleButton" onclick="$('#appModal').modal('hide');">
                                <div class="app-btn" id="cardDiv" style="margin: 10px;" >
                                   <img alt="Avatar" style="width:70px; height: 60px; margin-top: 10%;" id="cardImage">
                                   <div class="middle">
                                      <div class="text">
                                         <p id="apptext"></p>
                                      </div>
                                   </div>
                                   <div class="card-container">
                                      <h4>
                                         <b id="appName"></b>
                                      </h4>
                                      <p id="appDescription"></p>
                                   </div>
                                </div>
                             </a>
                          </template>
                       </div>
                    </div>
                 </div>
                 <!-- <div id="cover">
                  </div>
                  <div class="confirm">
                     <h1>Confirm your action</h1>
                     <p>Are you really <em>really</em> <strong>really</strong> sure that you want to void the selected encounter?</p>
                     <button onclick="hidePopup();">Cancel</button>
                     <button autofocus onclick="confirmAction();">Confirm</button>
                  </div> -->
            </div>
        </div>
    </div>
    <!-- /applications modal-->

        <!-- activities modal-->
    <div class="modal fade" id="activitiesModal" data-backdrop="static" data-keyboard="false" role="dialog">
        <div class="modal-dialog" name="div2">
            <div class="modal-content" style="margin-left:0px;">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Select activity</h4>
                 </div>
                 <div class="modal-body" id="activities-body">
                    <div class="container">
                       <div class="row" id="activities-modal-div">
                          <template id="activities_template">
                             <!-- <div class="" > -->
                             <div class="app-btn" id="cardDiv" style="margin: 10px;" >
                             <a href="#" class="card-block clearfix" id="moduleButton" onclick="$('#activitiesModal').modal('hide');">
                                <!-- <div class="app-btn" id="cardDiv" style="margin: 10px;" > -->
                                   <img alt="Avatar" style="width:70px; height: 60px; margin-top: 10%;" id="cardImage">
                                   <div class="middle">
                                      <div class="text">
                                         <p id="activitytext"></p>
                                      </div>
                                   </div>
                                   <div class="card-container">
                                      <h4>
                                         <b id="activityName"></b>
                                      </h4>
                                      <p id="activityDescription"></p>
                                   </div>
                             </a>
                             </div>
                          </template>
                       </div>
                    </div>
                 </div>
                 <!-- <div id="cover">
                  </div>
                  <div class="confirm">
                     <h1>Confirm your action</h1>
                     <p>Are you really <em>really</em> <strong>really</strong> sure that you want to void the selected encounter?</p>
                     <button onclick="hidePopup();">Cancel</button>
                     <button autofocus onclick="confirmAction();">Confirm</button>
                  </div> -->
            </div>
        </div>
    </div>
    <!-- /activities modal-->

  <!-- /container -->
  </div>
<!-- /body -->
</body>

<script src="/assets/js/core.js "></script>

<script>
  var patientID = "";
  var selectedEncounterID = "";  
  function finish() {
    window.location = "/";
  }
  var nextEnc = "";
  if (sessionStorage.nextEncounter != null) {
    nextEnc = sessionStorage.nextEncounter;
  }else {
    nextEnc = "None"
  }
  document.getElementById("nextEncounter").innerHTML = nextEnc;
    
  function changeIcon(gender) {
    var img = document.getElementById('icon_id');
    if (gender === "M") {
      img.setAttribute("src", "/assets/images/male.gif");
    } else {
      img.setAttribute("src", "/assets/images/female.gif");
    }
  }
  
  generateTemplate();

  var url = new URL(url);
  var apiURL = sessionStorage.getItem("apiURL");
  var apiPort = sessionStorage.getItem("apiPort");
  var apiProtocol = sessionStorage.getItem("apiProtocol");
  var id = url.searchParams.get("patient_id");
  sessionStorage.setItem("patientID", id);
  (document.getElementsByClassName("overview-btns ")[0]);
  (document.getElementsByClassName("activities-btns ")[0]);
  changeModule();
  url = new URL(url);
  var d = new Date();

  function ajaxRequest() {
    var url = 'http://' + apiURL + ':' + apiPort + '/api/v1/patients/' + id;
    var req = new XMLHttpRequest();
    req.onreadystatechange = function () {

      if (this.readyState == 4 && this.status == 200) {
        var results = JSON.parse(this.responseText);
        var age = results.person.birthdate;
        var gender = results.person.gender;
        var identifier = "";
        var patient_name = results.person.names[0].given_name + " " + results.person.names[0].family_name;
        
        try {
          var addressl1 = results.person.addresses[0].address1 ;
        var addressl2 = results.person.addresses[0].address2;
        var phone_number = results.person.person_attributes[1].value;
        }
        catch (e){
          var addressl1 = "";
        var addressl2 = "";
        var phone_number = "";
        }
        try {
          identifier = results.patient_identifiers[0].identifier || "no value available";
        } catch (e) {

        }

        setValues(patient_name, gender, age, addressl1, addressl2, phone_number, identifier);
      }
    };
    try {
      req.open('GET', url, true);
      req.setRequestHeader('Authorization', sessionStorage.getItem("authorization"))
      req.send(null);
    } catch (e) {}
  }

    function finish() {
      window.location = "/";
    }

    function setValues(patient_name, gender, age, addressl1, addressl2, phone_number, identifier) {
      document.getElementById("patient_name").innerHTML = patient_name;
      var roundedAge = Math.floor(moment().diff(age, 'years', true));
      document.getElementById("DOB").innerHTML = moment(age).format("DD/MMM/YYYY");;
      document.getElementById("npid").innerHTML = identifier;
      document.getElementById("age").innerHTML = "(" + roundedAge + ")";
      document.getElementById("addressl1").innerHTML = addressl1;
      document.getElementById("addressl3").innerHTML = addressl2;
      document.getElementById("phone_number").innerHTML = phone_number;
      changeIcon(gender);
    }

    function getDates(patient_id, index, pageNumber) {
      var url = 'http://' + apiURL + ':' + apiPort + '/api/v1/patients/' + patient_id + '/visits';
      var div = document.getElementById("dates");
      div.innerHTML = "";
      var req = new XMLHttpRequest();
      var counter = 0;
      id = patient_id;
      if (index < 0) {
        index = 0;
      }
      req.onreadystatechange = function () {

        if (this.readyState == 4 && this.status == 200) {
          var results = JSON.parse(this.responseText);
          document.getElementById("numberOfVisits").innerHTML = results.length;
          var lastPage = (results.length % 5);
          for (var x = index; x < results.length; x++) {
            if (counter == 0) {
              var prev = index - 5;
              document.getElementById("up").setAttribute('onClick', 'getDates('+patient_id +',' + prev +');');
              getValue(results[0], patient_id, "encounters", "h4", "table");
              getPrograms(patient_id);
              if (index == 0 || index % 5 == 0) {
                document.getElementById("up").setAttribute("disabled", "");
                document.getElementById("down").removeAttribute("disabled", "");
              }
              if (counter == results.length) {
                document.getElementById("down").setAttribute("disabled", "");
              } 

            }
            div.innerHTML += '<button type="button" id="' + x + '" value="' + results[x] +
              '" class="app-btn btn btn-primary" style="width: 90%;  margin-left: 5%;margin-top: 6%; margin-bottom: 6%; border-radius: 0%; color:black;"  onclick="this.style.color=0xffffff;getValue(this.value,' + patient_id + ',&#034encounters&#034, &#034h4&#034, &#034table&#034); getPrograms(' + patient_id + ');">' +
              moment(results[x]).format("DD/MMM/YYYY"); + '</button>';

            if (counter == 4 || (results.length - (index + counter) == 1)) {

              var next = index + counter + 1;
              var nextPage = pageNumber + 1;

              document.getElementById("down").setAttribute('onClick', 'getDates('+patient_id +',' + next +');');
              if ((results.length - (index + counter) == 1)) {
                document.getElementById("down").setAttribute("disabled", "");
              }if (index != 0)  {
                document.getElementById("up").removeAttribute("disabled", "");
                
              }

              break;

            }

            counter = ++counter;
          }
        }
      };
      try {
        req.open('GET', url, true);
        req.setRequestHeader('Authorization', sessionStorage.getItem('authorization'));
        req.send(null);
      } catch (e) {}
    }

    getDates(id, 0);

    function getValue(value, id, div, className, itemType) {
      var encounters = document.getElementById(div);
      var selectedDate = document.getElementById("selectedDate");
      selectedDate.innerHTML = moment(value).format("DD/MMM/YYYY");
      sessionStorage.setItem("value", value);
      if (encounters.innerHTML != null) {
        encounters.innerHTML = "";
      } else {}
      var url = 'http://' + apiURL + ':' + apiPort + '/api/v1/encounters?patient_id=' + id + '&date=' + value;
      var req = new XMLHttpRequest();
      var counter = 0;
      req.onreadystatechange = function () {

        if (this.readyState == 4 && this.status == 200) {

          var results = JSON.parse(this.responseText);
          document.getElementById("encounterHeader").innerHTML = results.length + " Encounters";
          for (var x = 0; x < results.length; x++) {
            var d = new Date(results[x].encounter_datetime);
            var f = moment(d).format("hh:mm:ss");

            if (itemType == "table") {

              encounters.innerHTML += '<tr><td id="' + x +
                '" class="h4" name="" style="width: 98%;  margin: 1%; border-radius: 0%; border-top-width: 0px;"><li>' +
                results[x].type.name + '</li></td> <td class="h4" style="border-top-width: 0px;">' + f + '</td> </tr>';
              if (x == 1) {
                encounters.innerHTML += '<li class ="h4" style="list-style: none;">...... click to view more </li>';
                break;

              }
            } else if (itemType == "button") {
              encounters.innerHTML +=
                '<button type="button" id="' + results[x].encounter_ixd + '" value="' + results[x] +
                '" class="btn btn-primary btn-sm" style="width: 98%;  margin: 1%; border-radius: 0%; height: 50px;" onClick="getEncounter(' + results[x].encounter_id + ')">' +
                '<span class="h5">' + results[x].type.name + '</span></button>';
            }

          }
        }
      };
      try {
        req.open('GET', url, true);
        req.setRequestHeader('Authorization', sessionStorage.getItem('authorization'));
        req.send(null);
      } catch (e) {}

    }

    function populateModal() {
      var location = document.getElementById("encounterDate");
      location.innerHTML = moment().format("DD/MMM/YYYY",sessionStorage.value);
      getValue(sessionStorage.value, sessionStorage.patientID, "encounters2", "btn btn-primary btn-lg", "button");
    }

    function getPrograms(id) {

      var programs = document.getElementById("programs");
      if (programs.innerHTML != null) {
        programs.innerHTML = "";
      } else {}
      var url = 'http://' + apiURL + ':' + apiPort + '/api/v1/patients/' + id + '/programs/';
      var req = new XMLHttpRequest();
      req.onreadystatechange = function () {

        if (this.readyState == 4 && this.status == 200) {
          var results = JSON.parse(this.responseText);
          for (var x = 0; x < results.length; x++) {
            var d = new Date(results[x].date_enrolled);
            var f = moment(d).format("hh:mm:ss");
            var name = results[x].program.concept.concept_names[0].name;
            programs.innerHTML += '<tr><td  id="' + x +
              '" class="h4" style="width: 98%;  margin: 1%; border-radius: 0%; border-top-width: 0px;" onclick="">' +
              name.toUpperCase() + '</td> <td style="border-top-width: 0px;" class="h4">' + f + '</td></tr>';
          }
        }
      };
      try {
        req.open('GET', url, true);
        req.setRequestHeader('Authorization', sessionStorage.getItem('authorization'));
        req.send(null);
      } catch (e) {}

    }

    function getEncounter(id) {

      var obsDiv = document.getElementById("observationsTable");
      if (obsDiv.innerHTML != null) {
        obsDiv.innerHTML = "";
      } else {}
      var url = 'http://' + apiURL + ':' + apiPort + '/api/v1/encounters/' + id;
      var req = new XMLHttpRequest();
      req.onreadystatechange = function () {

        if (this.readyState == 4 && this.status == 200) {

          var results = JSON.parse(this.responseText);

          for (var x = 0; x < results.observations.length; x++) {
            var d = new Date(results.observations[x].obs_datetime);
            var f = moment(d).format("hh:mm:ss");
            var value = "";
            if (results.observations[x].value_text != null) {
              value = results.observations[x].value_text;
            }else if (results.observations[x].value_numeric != null) {
              value = results.observations[x].value_numeric;
            }else if (results.observations[x].value_coded != null) {
               value = results.observations[x].value_coded;
              sessionStorage.removeItem("value_coded");
                var url = 'http://' + apiURL + ':' + apiPort + '/api/v1/concepts/' + results.observations[x].value_coded;
                var req = new XMLHttpRequest();
                req.onreadystatechange = function () {

                  if (this.readyState == 4) {
                    if (this.status == 200) {
                      var results = JSON.parse(this.responseText);  
                      value  = results.concept_names[0].name;
                      sessionStorage.setItem("value_coded", value);
                    }
                  }
                };
                try {
                  req.open('GET', url, false);
                  req.setRequestHeader('Authorization', sessionStorage.getItem('authorization'));
                  req.send(null);
                } catch (e) {
                }
                value = sessionStorage.getItem("value_coded");
                sessionStorage.removeItem("value_coded");
              
            }else if (results.observations[x].value_datetime != null){ 
              value = results.observations[x].value_datetime;
            }else {

            }
            obsDiv.innerHTML += '<tr>  <td>' + results.observations[x].concept.concept_names[0].name + '</td><td>' + value + '</td>  <td>' + f + '</td> </tr>'
          }
        }
      };
      try {
        req.open('GET', url, true);
        req.setRequestHeader('Authorization', sessionStorage.getItem('authorization'));
        req.send(null);
      } catch (e) {}

    }
    ajaxRequest();
      
   </script>
   <script>
      generateActivities();
      changeActivities();
    </script>
</html>
<script src="/assets/js/generic_ajaxrequest.js"></script> 