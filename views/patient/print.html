

<script type="text/javascript" src="/assets/js/generic_ajaxrequest.js"></script>
<script type="text/javascript" src="/assets/js/moment.js"></script>
<script type="text/javascript" src="/assets/js/demographics.js"></script>
<script type="text/javascript" src="/assets/js/httpUtils.js"></script>
<script type="text/javascript" src="/assets/js/patientState.js"></script>
<script>

let useFilingNumbers = false
const API_PATH = `http://${sessionStorage.getItem('apiURL')}:${sessionStorage.getItem('apiPort')}/api/v1`
const FILING_NUMBERS_ROUTE = '/apps/ART/views/file_numbers.html'
const PRE_ART_STATE_NAME = 'Pre-ART (Continue)'
const PERSON_ID = fetchArgumentFromUrlString('person_id')
const GUARDIAN_ID = fetchArgumentFromUrlString('guardian_id')
const PROGRAM_ID = sessionStorage.getItem('programID')
const PATIENT_FILE_LABEL = 'personData.lbl'
const GUARDIAN_FILE_LABEL = 'guardianLabel.lbl'

function init () {
  filingNumberIsActivated({
    authToken: sessionStorage.getItem('authorization')
  })
}

function setPatientDemographics (personId) {
  getDemographics(personId)
}

function fetchPersonNationalId (options = {}) {
  const url = `${API_PATH}/patients/${options.personId}/labels/national_health_id`
  const token = options.authToken

  const req = (window.XMLHttpRequest) ? new XMLHttpRequest() : new ActiveXObject('MicrosoftXMLHTTP')
  req.onload = () => {
    if (req.status === 200) {
      options.success(req.responseText)
    } else if (req.status >= 400) {
      options.error(error)
    }
  }

  req.open('GET', url, options.async)
  req.setRequestHeader('Authorization', options.authToken)
  req.send()
}

function printPersonInformation (options = {}) {
  setPatientDemographics(options.personId)

  fetchPersonNationalId({
    personId: options.personId,
    authToken: sessionStorage.getItem('authorization'),
    async: true,
    success: (data) => {
      print({
        filename: options.filename,
        data: data
      })
    },
    error: (error) => {
      options.error(error)
    }
  })
}

function print (options = {}) {
  const el = document.createElement('a')
  el.setAttribute('href', 'data:application/label;charset=utf-8,' + encodeURIComponent(options.data))
  el.setAttribute('download', options.filename)
  el.style.display = 'none'
  document.body.appendChild(el)
  el.click()
  document.body.removeChild(el)
}

function redirectPage() {
  sessionStorage.showPregnantQuestion= 'true';
  sessionStorage.showWeightChart = 'true';

  if (useFilingNumbers && parseInt(sessionStorage.programID) === 1) {
    document.location = `${FILING_NUMBERS_ROUTE}?patient_id=${PERSON_ID}`
  } else {
    nextEncounter(sessionStorage.patientID, 1, true);
  }
}

function filingNumberIsActivated (options = {}) {
  GET (
    {
      url: `${API_PATH}/global_properties?property=use.filing.numbers`,
      async: true,
      headers: {
        'Authorization': options.authToken
      }
    },
    {},
    (data) => {
      useFilingNumbers = (data['use.filing.numbers'] === 'true') ? true  : false
      createPatientState(
        {
          patientId: PERSON_ID,
          programId: PROGRAM_ID,
          authToken: sessionStorage.getItem('authorization'),
          stateName: PRE_ART_STATE_NAME,
          success: (data) => {
            printPersonInformation({
              personId: PERSON_ID,
              filename: PATIENT_FILE_LABEL
            })
            if (GUARDIAN_ID) {
              printPersonInformation({
                personId: GUARDIAN_ID,
                filename: GUARDIAN_FILE_LABEL
              })
            }
            setTimeout(redirectPage, 5000)
          },
          error: (error) => {
            console.error(error)
          }
        }
      )
    },
    (error) => {
      console.error(error)
    }
  )
}

init()
</script>

<style>

* {
-webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome and Opera */
}

.print-table {
  display: table;
  width: 99%;
  height: 99%;
}

.print-table-row {
  display: table-row;
}

.print-table-cell {
  display: table-cell;
  text-align: center;
}

.barcode {
  margin-top: 5%;
}

.print-table-cell p {
  font-size: 50px;
}

</style>


<div class="print-table">
  <div class="print-table-row">

    <div class="print-table-cell">
      <img src="/assets/images/zebra-label-printer.jpeg" class="barcode" />
      <p>Printing barcode label.</p>
      <p>Please wait <blink>....</blink><p>
    </div>


  </div>
</div>
