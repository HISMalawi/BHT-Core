var orders_table;

function activateDataTable() {
  orders_table = jQuery('#lab-orders').DataTable({
    fixedHeader: true,
    searching: false,
    paging: false,
    scroller: {
      loadingIndicator: true
    }
  });
}

function buildLabOrderDisplay() {
  var clearBTN = document.getElementById('clearButton');
  clearButton.style = 'display: none;';
  
  var f = document.getElementById('inputFrame' + tstCurrentPage);
  f.style = 'width: 96%; height: 88%;';

  var table = document.createElement('table');
  table.setAttribute('id','lab-orders');
  f.appendChild(table);

  var thead = document.createElement('thead');
  table.appendChild(thead);

  var tr = document.createElement('tr');
  thead.appendChild(tr);

  var heads = ['Test name','Tracking#','Status','Order date','Result','Result date'];
  for(var i = 0 ; i < heads.length ; i++){
    var th = document.createElement('th');
    th.innerHTML = heads[i];
    tr.appendChild(th); 
  }
  activateDataTable();
  

  addCreateOrderBTN();
}

function addCreateOrderBTN() {
  var root = document.getElementById('buttons');
  var order = document.createElement('button');
  order.setAttribute('onmousedown','pressOrder();');
  order.innerHTML = '<span>Order</span>';
  order.setAttribute('class','button blue navButton');
  root.appendChild(order);
}

function pressOrder() {
  var orderBox = document.createElement('div');
  orderBox.setAttribute('id','orders-box');
  
  var orderCover = document.createElement('div');
  orderCover.setAttribute('id','orders-cover');

  var container = document.createElement('div');
  container.setAttribute('id','orders-container');
  orderBox.appendChild(container);

  var orderNavBar = document.createElement('div');
  orderNavBar.setAttribute('id','orders-nav-bar');
  orderBox.appendChild(orderNavBar);

  var windowBody = document.getElementsByTagName('body')[0];
  try {
    var div1 = document.getElementById('orders-box');
    var div2 = document.getElementById('orders-cover');
    windowBody.removeChild(div1);
    windowBody.removeChild(div2);
  }catch(e) {
  }

  windowBody.appendChild(orderBox);
  windowBody.appendChild(orderCover);
  orderCover.style = 'display: inline;';
  orderBox.style = 'display: inline;';

  addNavButtons(orderNavBar);
  fetchAvailableTests();
}

function addNavButtons(ordersNavBar) {
  var nextB = document.createElement('button');
  nextB.innerHTML = '<span>Order test(s)</span>';
  nextB.setAttribute('class','button green navButton nav-orders-btns');
  nextB.setAttribute('onmousedown','nextChapter(0);');
  nextB.setAttribute('id','next-button');
  ordersNavBar.appendChild(nextB);

  var cancelB = document.createElement('button');
  cancelB.innerHTML = '<span>Cancel order</span>';
  cancelB.style = 'float: left; left: 5px;';
  cancelB.setAttribute('class','button red navButton nav-orders-btns');
  cancelB.setAttribute('onmousedown','cancelLabOrder();');
  ordersNavBar.appendChild(cancelB);
}

function cancelLabOrder() {
  var windowBody = document.getElementsByTagName('body')[0];
  var div1 = document.getElementById('orders-box');
  var div2 = document.getElementById('orders-cover');
  windowBody.removeChild(div1);
  windowBody.removeChild(div2);
}

function displayT(tests) {
  var container = document.getElementById('orders-container');
  
  var div = document.createElement('div');
  divCSS =  "height: 620px; width: 98%;";
  divCSS += "border: solid 1px; padding: 10px;";
  divCSS += "border-radius: 9px;";
  div.style = divCSS; 
  container.appendChild(div);

  var cells = ['tests-left','tests-right'];
  for(var i = 0 ; i < cells.length; i++){
    var cell = document.createElement('div');
    cellCSS =  'vertical-align: top;';
    cellCSS += 'height: 595px; width: 45%;';
    cellCSS += 'padding-left: 5px; overflow-x: hidden;';
    cell.style = cellCSS;
    cell.setAttribute('id', cells[i]);
    div.appendChild(cell);
  }
  addLefttable(tests); 
  addMainReasonForTests(); 
}

function addMainReasonForTests() {
  var container = document.getElementById('tests-right');
  container.setAttribute('class','options');

  var div = document.createElement('div');
  div.style = 'text-align: center;border-style: solid;border-width: 0px 0px 1px 0px;';
  div.innerHTML = 'Main test(s) reason';
  container.appendChild(div);

  var ul = document.createElement('ul');
  container.appendChild(ul);
      
  var reasons = ['Routine','Targeted','Confirmatory','Stat'];
  for(var i = 0 ; i < reasons.length ; i++){
    var oddEven = ( i & 1 ) ? "odd" : "even";

    var li = document.createElement('li');
    li.innerHTML = reasons[i];
    li.setAttribute('value', reasons[i]);
    li.setAttribute('reason', reasons[i]);
    li.setAttribute('id', i);
    li.setAttribute('class', 'test-reasons ' + oddEven);
    li.setAttribute('onmousedown', "selectReason(this);");
    ul.appendChild(li);
  }

}

function addUntickBox(th, i) {
  var img = document.createElement('img')
  img.setAttribute('id', 'order-' + i);
  img.setAttribute('src','/public/touchscreentoolkit/lib/images/unticked.jpg');
  img.style = 'width: 25px; height: 25px;';
  th.appendChild(img);
}

function addLefttable(tests) {
  var count = 50;
  var i = 0;
  
  var table = document.createElement('table');
  table.setAttribute('class','tests-tables');
  var container = document.getElementById('tests-left');
  container.appendChild(table);

  for(var i = 0 ; i < tests.sort().length ; i++) {
    var tr = document.createElement('tr');
    table.appendChild(tr);
    
    var td = document.createElement('td');
    /* .......... */
    var minTable = document.createElement('table');
    minTable.style = 'width: 100%;';
    var minTr = document.createElement('tr');
    minTable.appendChild(minTr);
    var minTH = document.createElement('th');
    minTH.style = "text-align: center; width: 5px;border-style: solid; border-width: 0px;";
    addUntickBox(minTH, i);
    minTr.appendChild(minTH);

    var minTD = document.createElement('td');
    minTD.innerHTML = tests[i];
    minTD.style = 'padding-left: 10px;';
    minTr.appendChild(minTD);

    td.appendChild(minTable);  
    /* .......... */

    td.setAttribute('class','tests-containers');
    td.setAttribute('onmousedown','selectTest(this);');
    td.setAttribute('test-selected','false');
    td.setAttribute('id','test-' + i);
    tr.appendChild(td);
      
    i++;
  }
}

function selectTest(e) {
  var selected = e.getAttribute('test-selected');
  var img = document.getElementById('order-' + e.id.split('-')[1]);

  if(selected == 'false'){
    e.style = 'background-color: lightblue;';
    e.setAttribute('test-selected', 'true');
    img.setAttribute('src','/public/touchscreentoolkit/lib/images/ticked.jpg');
  }else{
    e.style = 'background-color: ""';
    e.setAttribute('test-selected', 'false');
    img.setAttribute('src','/public/touchscreentoolkit/lib/images/unticked.jpg');
  }
}


function fetchAvailableTests() {
  var url = apiProtocol + "://" + apiURL + ":" + apiPort + "/api/v1";
  url += '/programs/1/lab_tests/types';

  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && (this.status == 201 || this.status == 200)) {
      var obs = JSON.parse(this.responseText);
      displayT(obs);
    }
  };
  xhttp.open("GET", url, true);
  xhttp.setRequestHeader('Authorization', sessionStorage.getItem("authorization"));
  xhttp.setRequestHeader('Content-type', "application/json");
  xhttp.send();
}

