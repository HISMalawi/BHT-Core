<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <script language="javascript" type="text/javascript" src="/touchscreentoolkit/lib/javascripts/touchScreenToolkit.js" defer="true"></script>
    <script language="javascript" type="text/javascript" src="/apps/core/assets/js/jquery.min.js" defer="true">
    </script>

    <script type="text/javascript">
      var tt_cancel_destination = "/";
    </script>
  </head>
  
  <body>
    <div id="container">
      <div id="content">
        <div style="padding-left: 15px;font-size:1.2em;">
        </div>
        <style type="text/css">
  #num{ display:none; }
  #char{ display:none; }
</style>
<script type="text/javascript">
  var people = [{}];
  var remote_people;


    var tt_cancel_destination = "/"

  function changeNextButtonText(text, pos , person_id, selected_person){
    __$('nextButton').innerHTML = "<span>" + text + "</span>";

    if (text.match(/New Patient/)){
      //clearFields
      var fields = [
        "identifier",
        "gender",
        "given_name",
        "family_name",
        "family_name2",
        "address2",
        "relation",
        "birthdate",
        "birthdate_estimated",
        "state_province",
        "city_village",
        "county_district",
        "occupation",
        "cell_phone_number",
        "national_id"
      ]
      for (k = 0; k < fields.length; k ++){
        try{
          __$(fields[k]).value = "";
          __$(fields[k]).removeAttribute("name");
        }catch(e){

        }
      }

      createControlAndAssignValue("given_name", "person[names][given_name]", sessionStorage.getItem("first_name"));
      createControlAndAssignValue("family_name", "person[names][family_name]", sessionStorage.getItem("given_name"));
      createControlAndAssignValue("gender", "person[gender]", "M");
    }

    if(pos && (person_id == 0) && !text.match(/New Patient/)){
      document.forms[0].action = "select";
      __$('nextButton').onmousedown = function(){
        document.forms[0].submit();
      }

      clearFields();

      pos = parseInt(pos);
      var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

      createControlAndAssignValue("remote", "remote", "true");

      if (selected_person){
        createControlAndAssignValue("gender", "person[gender]",selected_person[pos+1]["Gender"]);
        createControlAndAssignValue("given_name", "person[names][given_name]",selected_person[pos+1]["Name"].split(' ')[0]);
        createControlAndAssignValue("family_name", "person[names][family_name]",selected_person[pos+1]["Name"].split(' ')[1])
        createControlAndAssignValue("address2", "person[addresses][city_village]",selected_person[pos+1]["Current Residence"])
        createControlAndAssignValue("person_birth_year", "person[birth_year]",selected_person[pos+1]["Year"])
        try{
          createControlAndAssignValue("person_birth_month", "person[birth_month]",months.indexOf(selected_person[pos+1]["Month"]) + 1 );
        }
        catch(e){
          createControlAndAssignValue("person_birth_month", "person[birth_month]","");
        }
        createControlAndAssignValue("person_birth_day", "person[birth_day]",selected_person[pos+1]["Day"])
        createControlAndAssignValue("birthdate_estimated", "person[birthdate_estimated]", selected_person[pos+1]["Birthdate Estimated"]);
        createControlAndAssignValue("home_district", "person[addresses][address2]",selected_person[pos+1]["Home District"])
        createControlAndAssignValue("county_district", "person[addresses][county_district]",selected_person[pos+1]["Ancestral Traditional Authority(T/A)"])
        createControlAndAssignValue("occupation", "person[occupation]",selected_person[pos+1]["Occupation"])
        createControlAndAssignValue("national_id", "person[patient][identifiers][National id]",selected_person[pos+1]["Patient National ID"]);
      }

    } else {
      document.forms[0].action = "select";
      clearFields();
      __$('nextButton').onmousedown = function(){
        search_redirect = $('touchscreenInput' + tstCurrentPage).value;
        if (search_redirect.length > 0){
          window.location.href = "/apps/core/views/patient/new.html";
      }
      else{
          showMessage("Select value to continue");
      }
    }

      addFields();
      try{
        pos = parseInt(pos) + 1;
        $('identifier').value = people[pos]['Patient National ID'];
      }catch(e){
        if(!pos && text.match(/New Patient/)){
          $('identifier').value = "";
        }else{
          $('identifier').value = null;
        }
      }
    }
  }

  function createControlAndAssignValue(control, name, value){
    if(!__$(control)){
      var hidden = document.createElement("input");
      hidden.type = "hidden";
      hidden.id = control;
      hidden.value = "";

      document.forms[0].appendChild(hidden);
    }

    __$(control).name = name;
    __$(control).value = value;
  }

  function newSearch(){
    if (window.location.href.match(/\?identifier/))
      window.location.href = "/people/identifiers";
    else
      window.location.href = "/people/search";
  }

  function createNewSearchButton(){
    $('clearButton').innerHTML = "<span>New Search</span>";
    $('clearButton').setAttribute("onmousedown","newSearch();");
  }

  function newSearch() {
    document.location = "/people/search?relation="
  }

  function setAttributes() {
      var buttondiv = __$("buttons");
      buttondiv = document.getElementById("buttons");
      buttondiv.innerHTML += "<div id='tt_extraButtons'></div>"
      buttondiv.innerHTML+= "<button class='button navButton' id='newSearch' onmousedown='newSearch();'><span>New search</span></button>"
  }

  function search_remote(){
    return
    var url = "/people/dde_search?given_name=John" +
      "&family_name=Does&gender=M";

    ajaxGeneralRequest(url, "loadPatient()");

  }

  function loadPatient(){
    /*__$("summary").innerHTML = "";
    remote_people = JSON.parse(ajaxGeneralRequestResult);
     */
    people = [{}];

    var targetElement = tstFormElements[__$("touchscreenInput"+tstCurrentPage).getAttribute("refersToTouchscreenInputID")];

    var opts = __$("tt_currentUnorderedListOptions").getElementsByTagName("li");

    var selOptions = targetElement.getElementsByTagName("option");

    for(var i = opts.length-1; i > 0; i--){
      if(opts[i].id > 0){
        __$("tt_currentUnorderedListOptions").removeChild(opts[i]);
      }
    }

    for(var j = selOptions.length-1; j > 1; j--){
      targetElement.removeChild(selOptions[j]);
    }

    var pos = 1
    i = -1;

    //tstDualViewOptions = people;
  }

</script>

<body onload = "setTimeout('setAttributes();', 300);setItems();">
  <form action="" method="POST">
        <label for="person">No patients were found:</label>
    <select name="person[id]" id="person" dualView="true" dualViewOptions="people" tt_onUnload="">
      <!--option onmousedown="search_remote()">Search from remote server for person with name John Does</option-->

          <option value="0" onmousedown="changeNextButtonText('New Patient')" id="names" >Create a new person with the name </option>

    </select>
    <input type="hidden" id="identifier" name="identifier" value="" />
    <input type="hidden" id="gender" name="gender" value="" />
    <input type="hidden" id="given_name" name="given_name" value="" />
    <input type="hidden" id="family_name" name="family_name" value="" />
    <input type="hidden" id="family_name2" name="family_name2" value="" />
    <input type="hidden" id="address2" name="address2" value="" />
    <input type="hidden" id="relation" name="relation" value="" />
  </form>
  <script type="text/javascript" lang="javascript">
    <!--
    var ctrls = ["identifier", "gender", "given_name", "family_name", "family_name2", "address2", "relation"];

    function clearFields(){
      for(var i = 0; i < ctrls.length; i++){
        __$(ctrls[i]).removeAttribute("name");
      }
    }

    function addFields(){
      for(var i = 0; i < ctrls.length; i++){
        __$(ctrls[i]).setAttribute("name", ctrls[i]);
      }
    }
    
    //-->
  </script>
</body>

        <div id="footer">
          <div id="buttons" class="buttonsDiv" style="position: absolute; width: 98.7%;">
            <button id="finishButton" class="button navButton green" onclick="if (tt_cancel_destination) window.location = tt_cancel_destination;">
              <span>Finish</span>
            </button>
          </div>
        </div>

      </div>
    </div>
</body>
<script>
  function setItems(){
    var inputField = document.getElementById("names");
    var personName = document.createTextNode(" " + sessionStorage.getItem("first_name") + " " + sessionStorage.getItem("family_name") );
    inputField.appendChild(personName);
  }
</script>
</html>
